<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pakistan Air Quality Initiative (PAQI)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Montserrat:wght@400;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Design System --- */
        :root {
            --color-primary-blue: #003366;
            --color-secondary-blue: #0ea5e9;
            --color-background-light: #f9fafb;
            --color-background-dark: #1E2A3A;
            --color-text-dark: #333D4A;
            --color-text-light: #FFFFFF;
            --color-border: #DDE1E7;
            
            /* AQI Colors */
            --aqi-good: #22c55e;
            --aqi-moderate: #facc15;
            --aqi-usg: #f97316;
            --aqi-unhealthy: #ef4444;
            --aqi-very-unhealthy: #a855f7;
            --aqi-hazardous: #7e22ce;

            /* Mapping city colors */
            --color-lahore: #D94743;
            --color-karachi: #F49F0A;
            --color-peshawar: #5E3C99;
            --color-islamabad: #3153A5;
            
            --font-main: 'Poppins', sans-serif;
            --font-heading: 'Montserrat', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
            --transition-curve: cubic-bezier(0.25, 1, 0.5, 1);
            --shadow-subtle: 0 5px 15px rgba(45, 57, 65, 0.05);
            --shadow-lifted: 0 15px 35px rgba(45, 57, 65, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--color-text-light);
            color: var(--color-text-dark);
            -webkit-font-smoothing: antialiased;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            letter-spacing: -0.02em;
            font-weight: 700;
            color: var(--color-primary-blue);
        }

        p {
            font-family: var(--font-main);
            letter-spacing: 0em;
            font-weight: normal;
            color: var(--color-text-dark);
        }

        .container { width: 90%; max-width: 1200px; margin: 0 auto; padding: 100px 0; }
        .section-headline { font-size: clamp(1.5rem, 6vw, 3rem); max-width: 800px; margin: 0 auto 60px auto; text-align: center; font-weight: 500;}

        .animate-on-scroll { opacity: 0; transform: translateY(40px); transition: opacity 1s var(--transition-curve), transform 1s var(--transition-curve); }
        .animate-on-scroll.is-visible { opacity: 1; transform: translateY(0); }
        .delay-1 { transition-delay: 0.1s; } .delay-2 { transition-delay: 0.2s; } .delay-3 { transition-delay: 0.3s; }

/* --- Sticky Header --- */
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 2rem 0;
            transition: padding 1s ease, box-shadow 1s ease;
        }

        .header-scrolled {
            background-color: rgba(220, 220, 220, 0.2);
            backdrop-filter: blur(5px);
            box-shadow: var(--shadow-subtle);
            padding: 0.5rem 0;
        }
        
        .header-container {
            position: relative;
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 0.2px solid rgba(255,255,255,0.3);
            padding-bottom: 50px;
            transition: border-bottom 0.3s ease;
        }

        .header-scrolled .header-container {
            border-bottom: none;
            padding-bottom: 0px;
        }

        @media (max-width: 767px) {
        
            .header-container {
                padding-bottom: 20px;
            }
            .header-scrolled .header-logo-text {
            color: var(--color-primary-blue);
            font-size: 1rem;
            transition: color 1s, font-size 1s;
        }
        .header-logo-icon { height: 1.5rem; width: 1.5rem; color: var(--color-secondary-blue); }
        }

        @media (min-width: 768px) { 
            .header-logo-text {
            color: var(--color-primary-blue);
            font-size: 1.5rem;
            } 
        }

        .header-logo { display: flex; align-items: center; gap: 0.5rem; text-decoration: none; }
        .header-logo-icon { height: 2rem; width: 2rem; color: var(--color-secondary-blue); }
        .header-logo-text { font-size: 1.5rem; font-weight: 500; color: var(--color-text-light); transition: color 0.3s; }
        .header-logo-text:hover { color: var(--color-primary-blue); }
        .header-scrolled .header-logo-text { color: var(--color-primary-blue); }

        .header-nav { display: none; }
        @media (min-width: 768px) { 
            .header-nav { display: flex; align-items: center; gap: 2rem; } 
        }
        
        .header-nav-link { color: var(--color-text-light); text-decoration: none; font-weight: 300; transition: color 0.3s; }
        .header-scrolled .header-nav-link { color: var(--color-primary-blue); }
        .header-nav-link:hover { color: var(--color-secondary-blue); }
        
        .header-cta { display: none; }
        @media (min-width: 768px) { 
        .header-cta { 
            display: block; background-color: transparent; color: var(--color-text-light); border: 1.5px solid whitesmoke;
            padding: 0.5rem 1.25rem; border-radius: 100px; text-decoration: none; font-weight: 700; transition: all 0.3s; } 
        }
        .header-cta:hover { background-color: var(--color-primary-blue); transform: scale(1.1); border: none;}
        
        .mobile-menu-button { display: block; background: none; border: none; cursor: pointer; padding: 0; color: var(--color-text-light); transition: color 0.3s; }
        .header-scrolled .mobile-menu-button { color: var(--color-primary-blue); }
        .mobile-menu-icon { width: 1.75rem; height: 1.75rem; }
        @media (min-width: 768px) { 
            .mobile-menu-button { display: none; } .mobile-menu-icon { width: 1rem; height: auto; } 
        }
        .mobile-menu { background-color: white; padding: 1rem; border-radius: 8px; box-shadow: var(--shadow-lifted); margin-top: 1rem; width: 90%; max-width: 1200px; margin-left: auto; margin-right: auto; }
        .mobile-menu.hidden { display: none; }
        .mobile-menu a { display: block; padding: 0.75rem 1rem; color: var(--color-text-dark); text-decoration: none; font-weight: 600; border-radius: 6px; }
        .mobile-menu a:hover { background-color: var(--color-background-light); }

/* --- Hero Section --- */
        .hero-section { height: 100vh; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; padding: 0 1rem; }
        .hero-slide-container { position: absolute; inset: 0; }
        .hero-slide { position: absolute; inset: 0; background-size: cover; background-position: center; opacity: 0; z-index: 0; transform: scale(1); transition: opacity 2s ease-in-out, transform 10s ease-in-out; }
        .hero-slide.active { opacity: 1; z-index: 1; transform: scale(1.2); }
        .is-loaded .hero-slide.active { opacity: 1; z-index: 1; transform: scale(1.2); }
        .hero-overlay { position: absolute; inset: 0; background-color: rgba(0, 20, 40, 0.6); }
        .hero-content { position: relative; z-index: 10; width: 90%; max-width: 1200px; margin-top: 0; justify-content: flex-start; text-align: left; }
        .hero-text-container { max-width: 650px; margin: 0; width: 100%; }
        @media (min-width: 768px) { 
            .hero-section { padding: 0; align-items: center; } 
        }
        .hero-content h1 { font-size: clamp(2.5rem, 8vw, 4.5rem); color: var(--color-text-light); margin-left: 0; text-align: left; font-weight: 500; }
        .hero-content p { font-size: clamp(1rem, 3vw, 1.25rem); color: var(--color-text-light); opacity: 0.9; max-width: 700px; margin: 0 0 1rem 0; text-align: left; }
        .hero-content .cta-button { margin-left: 0; text-decoration: none; color: #DDE1E7; }
        .hero-content .cta-button:hover { transform: translateY(-3px); color: var(--color-primary-blue); font-weight: bolder;}
        .hero-nav-links { position: absolute; bottom: 2.5rem; left: 50%; transform: translateX(-50%); z-index: 10; width: 90%; max-width: 1200px; font-weight: 600; display: flex; overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; gap: 1rem; }
        .hero-nav-links a { display: flex; flex-shrink: 0; padding: 0rem 0 1rem 0; color: rgba(255, 255, 255, 0.8); text-decoration: none; border-bottom: 2px solid rgba(255, 255, 255, 0.3); width: 200px; transition: all 0.3s; white-space: nowrap; font-weight: 400; }
        .hero-nav-links::-webkit-scrollbar { display: none; }
        .hero-nav-links a:hover { color: white; font-weight: 600; border-bottom-color: var(--color-primary-blue); width: 225px; transition: all 0.5s; }
        .hero-nav-grid { display: flex; gap: 1rem; }
        @media (min-width: 768px) { 
            .hero-nav-links { 
                display: block; 
                overflow: visible; 
                white-space: normal; 
                padding-left: 0; padding-right: 0; 
            } 
            .hero-nav-grid { 
                grid-template-columns: repeat(4, 1fr); 
                gap: 1rem; 
                width: 100%; 
                max-width: 1200px; 
                margin: 0 auto; 
                display: flex; 
                justify-content: space-between; 
            } 
        }

/* --- AQI Widget (Aligned with Header Container) --- */
        .aqi-widget {
            /* --- Positioning --- */
            position: absolute;
            top: 100%; /* Position the top of the widget at the bottom of the header container */
            right: 0;  /* Align the right edge of the widget with the right edge of the header container */
            margin-top: 1.5rem; /* Add some space below the header's bottom border */
            z-index: 20;

            /* --- Visuals & Sizing --- */
            background: rgba(40, 40, 40, 0.2);
            backdrop-filter: blur(5px);
            color: #FFFFFF;
            padding: 0.75rem 1.5rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 1.2rem;
            transform: scale(0.9); /* Slightly scale it down to match the design */
            transform-origin: top right; /* Scale from the corner it's anchored to */
            transition: transform 0.3s ease, box-shadow 0.3s ease;

            cursor: pointer; /* Add this to show it's clickable */
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .aqi-widget:hover {
            transform: translateY(-2px) scale(0.92);
            box-shadow: var(--shadow-lifted);
        }

        .aqi-text-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            transition: opacity 0.2s ease-out, transform 0.3s ease-out;
        }

        .aqi-title { font-size: 0.9rem; font-weight: 500; opacity: 0.8; transition: opacity 0.2s ease-out, transform 0.3s ease-out; }
        .aqi-value { font-size: 2rem; font-weight: 700; transition: font-size 0.4s ease-in-out;}
        .aqi-category { font-size: 1rem; font-weight: 600; text-transform: uppercase; }
        .aqi-city { font-size: 0.9rem; opacity: 0.8; }


        /* --- Mobile Styles --- */
        /* On mobile, we detach it and let it float freely again */
        @media (max-width: 767px) {
            .aqi-widget {
                position: fixed; /* Detach from the header on mobile */
                top: 8rem;
                right: 1rem;
                transform: scale(0.8); /* Adjust scale for mobile */
                margin-top: 0; /* Reset the margin */
            }
        }

        /* AQI Color classes are unchanged and should work as before */
        .aqi-good { color: var(--aqi-good); }
        .aqi-moderate { color: var(--aqi-moderate); }
        .aqi-usg { color: var(--aqi-usg); }
        .aqi-unhealthy { color: var(--aqi-unhealthy); }
        .aqi-very-unhealthy { color: var(--aqi-very-unhealthy); }
        .aqi-hazardous { color: var(--aqi-hazardous); }

/* --- Impact Section --- */
        .impact-section { background-color: white; }
        .impact-section .section-headline { font-size: 2rem; font-weight: 600; max-width: 1200px; margin: 0 auto 60px auto; text-align: center; position: relative; display: flex; align-items: center; justify-content: center; }
        .impact-section .section-headline::before, .impact-section .section-headline::after { content: ''; flex-grow: 1; height: 1px; background-color: var(--color-border); }
        .impact-section .section-headline::before { margin-right: 1rem; }
        .impact-section .section-headline::after { margin-left: 1rem; }
        .impact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; text-align: center; }
        .impact-item { padding: 2.5rem 2rem; border-radius: 12px; color: var(--color-text-light); box-shadow: var(--shadow-subtle); transition: transform 0.3s, box-shadow 0.3s; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .impact-item:nth-child(1), .impact-item:nth-child(2), .impact-item:nth-child(3) { background-color: var(--color-primary-blue); }
        .impact-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-lifted); }
        .impact-item-icon { display: none; }
        .impact-item-number { font-family: var(--font-heading); font-size: clamp(2rem, 7vw, 3rem); font-weight: 500; color: inherit; margin-bottom: 0.5rem; line-height: 1; }
        .impact-item-text { font-size: 1rem; color: inherit; opacity: 1; max-width: 250px; margin: 0; }
        .impact-section .more-monitors-headline { font-size: 24px; font-weight: 300; padding-top: 30px; text-align: center; color: var(--color-text-dark); }
        .impact-section .more-monitors-headline:hover { transform: scale(1.1); font-weight: 500; color: var(--color-primary-blue); transition: 1s; }

/* --- Partners Section --- */
        .partners-section { padding: 80px 0; overflow: hidden; text-align: center; }
        .partners-slider { display: flex; overflow: hidden; max-width: 100%; -webkit-mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent); mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent); }
        .slide-track { display: flex; gap: 80px; will-change: transform; animation: scroll 17s linear infinite; }
        .slide { width: auto; height: 100px; display: flex; align-items: center; justify-content: center; flex: 0 0 auto; }
        .partner-logo { max-height: 50px; width: auto; filter: grayscale(100%); opacity: 0.7; transition: all 0.3s; }
        .partner-logo:hover { filter: grayscale(0); opacity: 1; transform: scale(1.1); }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        @media (max-width: 768px) { 
            .partners-slider { padding: 0 20px; } .slide-track { gap: 40px; } .slide { width: 100px; height: 80px; } .partner-logo { max-height: 40px; } 
        }

/* --- Map Section --- */
        .map-section { background-color: var(--color-background-dark); padding: 50px 0; }
        .map-section .section-headline { color: var(--color-text-light); }
        .map-grid { display: grid; grid-template-columns: 1fr; gap: 3rem; align-items: center; }
        @media (min-width: 768px) { 
            .map-grid { grid-template-columns: 1fr 1fr; } 
        }
        .map-legend p { color: var(--color-text-light); opacity: 0.8; margin-bottom: 1.5rem; }
        .map-legend-items { display: flex; flex-wrap: wrap; gap: 1rem; }
        .legend-item { display: flex; align-items: center; font-size: 0.9rem; color: var(--color-text-light); }
        .legend-color-box { width: 1rem; height: 1rem; border-radius: 4px; margin-right: 0.5rem; }
        .map-container { position: relative; max-width: 700px; height: auto; margin: 0 auto; }
        .map-image { display: block; width: 100%; height: auto; filter: brightness(0.9) contrast(1.1); }
        .map-marker { position: absolute; width: 20px; height: 20px; transform: translate(-50%, -50%); cursor: pointer; }
        .map-marker::before, .map-marker::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; }
        .map-marker::before { width: 100%; height: 100%; border: 2px solid var(--marker-color); animation: pulse 2.5s infinite; }
        .map-marker::after { width: 8px; height: 8px; background-color: var(--marker-color); transition: transform 0.3s var(--transition-curve); }
        .map-marker:hover::after { transform: translate(-50%, -50%) scale(1.4); }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
        .map-tooltip { position: absolute; background: rgba(255,255,255,0.98); backdrop-filter: blur(8px); color: var(--color-text-dark); padding: 10px 15px; border-radius: 8px; box-shadow: var(--shadow-lifted); border: 1px solid var(--color-border); width: 240px; text-align: left; pointer-events: none; opacity: 0; transform: translateY(10px) scale(0.95); transition: opacity 0.3s, transform 0.3s; transform-origin: bottom center; }
        .map-tooltip.is-visible { opacity: 1; transform: translateY(0) scale(1); }
        .map-tooltip h4 { font-size: 1rem; margin-bottom: 4px; }
        .map-tooltip p { font-size: 0.9rem; margin: 0; }
        .map-tooltip .aqi-value { font-weight: 700; font-size: 1.1rem; }
        .map-tooltip .unit { font-size: 0.8rem; opacity: 0.7; margin-left: 4px;}

/* --- Chart Section --- */
        .chart-wrapper {width: 90%; max-width: 1200px; margin: 100px auto 0;}
        .dataviz-section { overflow: hidden; background: var(--color-background-light); align-content: center;}
        .chart-grid { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-start; }
        @media (max-width: 767px) {
        .chart-svg-container {
            overflow-x: auto; /* Allows horizontal scrolling */
            -webkit-overflow-scrolling: touch; /* Adds smooth, native-like scrolling on iOS */
            padding-bottom: 15px; /* Adds some space so the scrollbar doesn't overlap content */
        }
        }
        .chart-container {flex: 1 1 50%; padding: 2rem;}
        .chart-header { flex: 1 1 50%;padding-right: 2rem; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: -30px; margin-top: 60px; justify-content: center;}
        .legend-item { color: var(--color-background-dark); display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: opacity 0.3s; }
        .legend-item.is-dimmed { opacity: 0.3; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .chart-svg-container { position: relative; margin-top: -30px;}
        .chart-svg { overflow: visible; width: max-content; }
        .chart-svg .data-line { fill: none; stroke-width: 3.5; stroke-linecap: round; stroke-linejoin: round; transition: opacity 0.4s var(--transition-curve); }
        .chart-svg .data-line.is-dimmed { opacity: 0.15; }
        .chart-svg .data-point { fill: var(--color-text-light); stroke: var(--color-text-dark); stroke-width: 2px; transition: r 0.3s, opacity 0.4s; }
        .chart-svg .data-point.is-dimmed { opacity: 0; }
        .chart-svg .data-point:hover { r: 6; }
        .chart-svg .tooltip-text { fill: var(--color-text-dark); font-size: 12px; font-weight: 500; }
        .y-axis .tick line { stroke: var(--color-border); }
        .y-axis .tick:first-of-type line { stroke-dasharray: 4 4; }
        .y-axis .tick text { font-family: var(--font-main); fill: var(--color-text-dark); font-size: 12px; }
        .y-axis .domain { display: none; }
        .tooltip { position: absolute; background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); pointer-events: none; opacity: 0; }

/* --- Blog & Team Sections --- */
        .blog-section, .team-section { background-color: var(--color-text-light); }
        .blog-section .section-headline, .team-section .section-headline { font-size: 2rem; font-weight: 600; max-width: 1200px; margin: 0 auto 60px auto; text-align: center; position: relative; display: flex; align-items: center; justify-content: center; }
        .blog-section .section-headline::before, .blog-section .section-headline::after { content: ''; flex-grow: 1; height: 1px; background-color: var(--color-border); }
        .blog-section .section-headline::before { margin-right: 1rem; }
        .blog-section .section-headline::after { margin-left: 1rem; }
        .blog-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .blog-card { background: white; border-radius: 12px; box-shadow: var(--shadow-subtle); overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; text-decoration: none; }
        .blog-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lifted); }
        .blog-card-image-wrapper { overflow: hidden; height: 200px; }
        .blog-card-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
        .blog-card:hover .blog-card-image { transform: scale(1.05); }
        .blog-card-content { padding: 1.5rem; }
        .blog-card h3 { font-family: var(--font-heading); font-size: 1.25rem; font-weight: 600; color: black; margin-bottom: 0.5rem; transition: color 0.3s; }
        .blog-card:hover h3 { color: var(--color-secondary-blue); }
        .blog-card p { font-size: 0.95rem; margin-bottom: 1rem; opacity: 0.8; }
        .blog-card-link { font-weight: 600; color: var(--color-primary-blue); text-decoration: none; }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 2rem; }
        .team-card { text-align: center; transition: transform 0.3s; }
        .team-card:hover { transform: scale(1.05); }
        .team-card-image { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; margin: 0 auto 1rem auto; box-shadow: 0 0 0 4px white, var(--shadow-lifted); }
        .team-card h4 { font-size: 1.2rem; margin-bottom: 0.25rem; }
        .team-card p { font-size: 0.9rem; color: var(--color-secondary-blue); opacity: 1; }

/* --- Footer --- */
        .site-footer { background: var(--color-primary-blue); color: rgba(255, 255, 255, 0.7); padding: 25px 0; margin-bottom: -75px;}
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
        .footer-col h4 { color: white; font-size: 1.1rem; margin-bottom: 1rem; }
        .footer-col p, .footer-col a { font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-decoration: none; }
        .footer-col a:hover { color: white; }
        .footer-col ul { list-style: none; padding: 0; }
        .footer-col ul li { margin-bottom: 0.5rem; }
        .footer-socials { display: flex; gap: 1rem; margin-top: 1rem; }
        .footer-socials a { color: rgba(255, 255, 255, 0.7); }
        .footer-socials a:hover { color: white; }
        .footer-subscribe-form { display: flex; margin-top: 1rem; }
        .footer-subscribe-form input { width: 100%; border: none; padding: 0.75rem; border-radius: 6px 0 0 6px; background: rgba(255,255,255,0.1); color: white; }
        .footer-subscribe-form input::placeholder { color: rgba(255,255,255,0.5); }
        .footer-subscribe-form button { border: none; background: var(--color-secondary-blue); color: white; padding: 0.75rem 1rem; border-radius: 0 6px 6px 0; cursor: pointer; font-weight: 700; }
        .footer-bottom { margin-bottom: -30px; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.2); text-align: center; font-size: 0.9rem; }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>

    <header class="site-header" id="main-header">
        <div class="header-container">
            <a href="#" class="header-logo">
                <img class="header-logo-icon" src="/utils/logo.png" alt="Logo" />
                <span class="header-logo-text">Pakistan Air Quality Initiative</span>
            </a>
            <nav class="header-nav">
                <a href="#impact" class="header-nav-link">Impact</a>
                <a href="#map" class="header-nav-link">Map</a>
                <a href="#chart" class="header-nav-link">Data</a>
                <a href="#blog" class="header-nav-link">Our Insights</a>
                <a href="#team" class="header-nav-link">Our Team</a>
            </nav>
            <a href="#footer" class="header-cta">Let's Chat</a>
            <button id="mobile-menu-button" class="mobile-menu-button" aria-label="Toggle menu">
                <svg class="mobile-menu-icon" viewBox="0 0 24 24">...</svg>
            </button>
            
            <div class="aqi-widget" id="aqi-widget">
                <div class="aqi-title">AQI</div>
                <div class="aqi-value" id="aqi-value">...</div>
                <div class="aqi-category" id="aqi-category">Fetching</div>
                <div class="aqi-city" id="aqi-city">Determining location...</div>
            </div>
        </div>
        <div id="mobile-menu" class="mobile-menu hidden"></div>
    </header>

    <main>
        <section id="hero" class="hero-section">
            <div class="aqi-widget" id="aqi-widget">
                <div class="aqi-title">AQI</div>
                <div class="aqi-value" id="aqi-value">...</div>
                <div class="aqi-category" id="aqi-category">Fetching</div>
                <!-- <div class="aqi-pollutant" id="aqi-pollutant"></div> -->
                <div class="aqi-city" id="aqi-city">Determining location...</div>
            </div>

            <div class="hero-slide-container">
                <div id="slide-1" class="hero-slide active" style="background-image: url('/utils/pic1.png');"></div>
                <div id="slide-2" class="hero-slide" style="background-image: url('/utils/pic2.png');"></div>
                <div id="slide-3" class="hero-slide" style="background-image: url('/utils/pic3.jpeg');"></div>
                <div id="slide-4" class="hero-slide" style="background-image: url('/utils/pic4.jpg');"></div>
            </div>
            <div class="hero-overlay"></div>
            <div id="hero-text-content" class="hero-content">
                <div class="hero-text-container">
                    <h1>Clearing the Air for a Healthier Pakistan</h1>
                    <p>Air pollution is the nation's leading environmental threat. We are dedicated to providing the data and tools needed to drive change.</p>
                    <a href="#impact" class="cta-button">Learn About The Crisis &rarr;</a>
                </div>
            </div>
        </section>

        <div class="hero-nav-links">
            <div class="hero-nav-grid">
                <a href="#impact" class="hero-nav-link">Our Impact</a>
                <a href="#map" class="hero-nav-link">Interactive Map</a>
                <a href="#chart" class="hero-nav-link">Latest Data</a>
                <a href="#partners" class="hero-nav-link">Our Partners</a>
            </div>
        </div>

        <section id="impact" class="impact-section container">
            <h2 class="section-headline animate-on-scroll">Our Data-Driven Impact</h2>
            <div class="impact-grid">
                <div class="impact-item animate-on-scroll">
                    <div class="impact-item-number">150+</div>
                    <p class="impact-item-text">Monitoring Stations</p>
                </div>
                <div class="impact-item animate-on-scroll delay-1">
                    <div class="impact-item-number">2M+</div>
                    <p class="impact-item-text">People Reached</p>
                </div>
                <div class="impact-item animate-on-scroll delay-2">
                    <div class="impact-item-number">7.5K+</div>
                    <p class="impact-item-text">Social Media Followers</p>
                </div>
            </div>
            <div style="padding-top: 120px; text-align: center;">
                <svg width="80" height="auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" >
                    <path fill="gray" d="M177.8 63.2l10 17.4c2.8 4.8 4.2 10.3 4.2 15.9v41.4c0 3.9 1.6 7.7 4.3 10.4c6.2 6.2 16.5 5.7 22-1.2l13.6-17c4.7-5.9 12.9-7.7 19.6-4.3l15.2 7.6c3.4 1.7 7.2 2.6 11 2.6c6.5 0 12.8-2.6 17.4-7.2l3.9-3.9c2.9-2.9 7.3-3.6 11-1.8l29.2 14.6c7.8 3.9 12.6 11.8 12.6 20.5c0 10.5-7.1 19.6-17.3 22.2l-35.4 8.8c-7.4 1.8-15.1 1.5-22.4-.9l-32-10.7c-3.3-1.1-6.7-1.7-10.2-1.7c-7 0-13.8 2.3-19.4 6.5L176 212c-10.1 7.6-16 19.4-16 32v28c0 26.5 21.5 48 48 48h32c8.8 0 16 7.2 16 16v48c0 17.7 14.3 32 32 32c10.1 0 19.6-4.7 25.6-12.8l25.6-34.1c8.3-11.1 12.8-24.6 12.8-38.4V318.6c0-3.9 2.6-7.3 6.4-8.2l5.3-1.3c11.9-3 20.3-13.7 20.3-26c0-7.1-2.8-13.9-7.8-18.9l-33.5-33.5c-3.7-3.7-3.7-9.7 0-13.4c5.7-5.7 14.1-7.7 21.8-5.1l14.1 4.7c12.3 4.1 25.7-1.5 31.5-13c3.5-7 11.2-10.8 18.9-9.2l27.4 5.5C432 112.4 351.5 48 256 48c-27.7 0-54 5.4-78.2 15.2zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"></path>
                </svg>
            </div>
            <h2 class="more-monitors-headline animate-on-scroll"> More monitors coming soon... </h2>
        </section>

        <section id="partners" class="partners-section">
            <h2 class="section-headline animate-on-scroll" style="margin-bottom: 20px;">Stronger Together</h2>
            <p style="margin-bottom: 30px;">We collaborate with leading organizations to maximize our impact and drive systemic change.</p>
            <div class="partners-slider">
                <div class="slide-track">
                    <div class="slide"><img class="partner-logo" src="/utils/iqair.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/breathepak.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/lums.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/lei.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/uol.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/wwf.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/umt.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/iqair.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/breathepak.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/lums.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/lei.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/uol.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/wwf.png" alt="Partner Logo" /></div>
                    <div class="slide"><img class="partner-logo" src="/utils/umt.png" alt="Partner Logo" /></div>
                </div>
            </div>
        </section>

        <section id="map" class="map-section">
            <div class="container">
                <div class="map-grid">
                    <div class="map-legend animate-on-scroll">
                        <h2 class="section-headline" style="text-align: left; color: white;">Annual PM2.5 Concentration in 2024</h2>
                        <p>Our network provides a real-time snapshot of the air quality in major urban centers. Explore the map to see the current annual average PM2.5 levels.</p>
                        <div class="map-legend-items">
                            <div class="legend-item" style="color: #DDE1E7;"><span class="legend-color-box" style="background-color: var(--aqi-good);"></span> Good</div>
                            <div class="legend-item" style="color: #DDE1E7;"><span class="legend-color-box" style="background-color: var(--aqi-moderate);"></span> Moderate</div>
                            <div class="legend-item" style="color: #DDE1E7;"><span class="legend-color-box" style="background-color: var(--aqi-usg);"></span> Unhealthy (SG)</div>
                            <div class="legend-item" style="color: #DDE1E7;"><span class="legend-color-box" style="background-color: var(--aqi-unhealthy);"></span> Unhealthy</div>
                            <div class="legend-item" style="color: #DDE1E7;"><span class="legend-color-box" style="background-color: var(--aqi-very-unhealthy);"></span> Very Unhealthy</div>
                        </div>
                    </div>
                    <div class="map-container animate-on-scroll delay-1">
                        <img src="/utils/pak.png" class="map-image" alt="Map of Pakistan with AQI hotspots">
                        <div id="map-interactive-layer"></div>
                        <div id="map-tooltip" class="map-tooltip"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="chart" class="dataviz-section">
            <div class="chart-wrapper animate-on-scroll">
                <div class="chart-grid">
                    <div class="chart-header">
                        <h2 class="section-headline" style="text-align: left; color: var(--color-text-dark); margin: 0 0 10px 0;">A Decade of Data</h2>
                        <p>Our network has chronicled the air quality crisis across Pakistan. While yearly fluctuations exist, the trend is clear: annual pollution levels remain dangerously high, consistently exceeding WHO safe limits.</p>
                        <div id="chart-legend" class="chart-legend"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-svg-container">
                            <svg id="timeline-chart" class="chart-svg" viewBox="0 0 800 400" width="800" height="400"></svg>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="blog" class="blog-section container">
            <h2 class="section-headline animate-on-scroll">Our Latest Insights</h2>
            <div class="blog-grid">
                <a href="#" class="blog-card animate-on-scroll">
                    <div class="blog-card-image-wrapper"><img src="/utils/airpurifier.jpg" alt="Air purifier" class="blog-card-image"></div>
                    <div class="blog-card-content">
                        <h3>How to Choose the Right Air Purifier</h3>
                        <p>A practical guide to understanding HEPA filters, CADR ratings, and finding the perfect device for your space.</p>
                        <span class="blog-card-link">Read More &rarr;</span>
                    </div>
                </a>
                <a href="#" class="blog-card animate-on-scroll delay-1">
                    <div class="blog-card-image-wrapper"><img src="/utils/traffic.jpg" alt="Traffic in a city" class="blog-card-image"></div>
                    <div class="blog-card-content">
                        <h3>Policy on Vehicular Emissions</h3>
                        <p>Our latest recommendations for the government to tackle traffic pollution, one of the largest sources of smog.</p>
                        <span class="blog-card-link">Read More &rarr;</span>
                    </div>
                </a>
                <a href="#" class="blog-card animate-on-scroll delay-2">
                    <div class="blog-card-image-wrapper"><img src="/utils/community.jpg" alt="Community meeting" class="blog-card-image"></div>
                    <div class="blog-card-content">
                        <h3>Community Spotlight: Citizens Fighting Back</h3>
                        <p>How a neighborhood used our data to advocate for green spaces and reduce local industrial pollution.</p>
                        <span class="blog-card-link">Read More &rarr;</span>
                    </div>
                </a>
            </div>
        </section>

        <section id="team" class="team-section container">
            <h2 class="section-headline animate-on-scroll">The People Behind the Data</h2>
            <div class="team-grid">
                <div class="team-card animate-on-scroll"><img src="/utils/Abid.jpeg" alt="Abid" class="team-card-image"><h4>Abid Omar</h4><p>Founder & Director</p></div>
                <div class="team-card animate-on-scroll delay-1"><img src="/utils/Dawar.jpg" alt="Dawar Butt" class="team-card-image"><h4>Dawar Butt</h4><p>Chief Executive Officer</p></div>
                <div class="team-card animate-on-scroll delay-2"><img src="/utils/Mahad.jpeg" alt="Mahad Naveed" class="team-card-image"><h4>Mahad Naveed</h4><p>Lead Data Scientist</p></div>
                <div class="team-card animate-on-scroll delay-3"><img src="https://placehold.co/200x200/e2e8f0/334155?text=MS" alt="Mariam Shah" class="team-card-image"><h4>Mariam Shah</h4><p>Communications Lead</p></div>
            </div>
        </section>
    </main>

    <footer id="footer" class="site-footer">
        <div class="container" style="padding-top: 5rem; padding-bottom: 4rem;">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>About PAQI</h4>
                    <p>The Pakistan Air Quality Initiative (PAQI) is an independent research and advocacy organization dedicated towards a breathable and healthy Pakistan, with robust scientific insights and data-driven solutions to overcome the air pollution crisis. Our vision is a future where every Pakistani breathes clean air, supported by informed policies and an engaged society.</p>
                    <div class="footer-socials">
                        <a href="#"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22.675 0h-21.35C.59 0 0 .59 0 1.325v21.35C0 23.41.59 24 1.325 24H12.82v-9.29H9.692v-3.622h3.128V8.413c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12V24h6.116c.735 0 1.325-.59 1.325-1.325V1.325C24 .59 23.41 0 22.675 0z"></path></svg></a>
                        <a href="#"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.223.085a4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.213 0-.425-.015-.637A9.935 9.935 0 0024 4.59z"></path></svg></a>
                        <a href="#"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 114.128 0c0 1.14-.926 2.065-2.065 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z"></path></svg></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Navigate</h4>
                    <ul>
                        <li><a href="#impact">Impact</a></li>
                        <li><a href="#map">Live Map</a></li>
                        <li><a href="#chart">Data & Charts</a></li>
                        <li><a href="#team">Our Team</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                     <ul>
                        <li><a href="#blog">Insights</a></li>
                        <li><a href="#">Research Papers</a></li>
                        <li><a href="#">Press Kit</a></li>
                        <li><a href="#">Contact Us</a></li>
                    </ul>
                </div>
                 <div class="footer-col">
                    <h4>Subscribe</h4>
                    <p>Get the latest air quality news and health advisories.</p>
                    <form class="footer-subscribe-form">
                        <input type="email" placeholder="Your email">
                        <button type="submit">Go</button>
                    </form>
                </div>
            </div>
            <div class="footer-bottom">
                <p style="color: #DDE1E7;">&copy; 2025 Pakistan Air Quality Initiative. All Rights Reserved. | <a style="color: #0ea5e9;" href="#">Privacy Policy</a></p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Header & Mobile Menu Logic ---
            const header = document.getElementById('main-header');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const desktopNav = document.querySelector('.header-nav');
            
            // Dynamically create mobile menu from desktop nav
            mobileMenu.innerHTML = '';
            const navLinks = desktopNav.querySelectorAll('a');
            navLinks.forEach(link => {
                const mobileLink = document.createElement('a');
                mobileLink.href = link.href;
                mobileLink.textContent = link.textContent;
                mobileMenu.appendChild(mobileLink);
            });
            const ctaButton = document.querySelector('.header-cta');
            if (ctaButton) {
                const mobileCta = document.createElement('a');
                mobileCta.href = ctaButton.href;
                mobileCta.textContent = ctaButton.textContent;
                mobileMenu.appendChild(mobileCta);
            }

            window.addEventListener('scroll', () => {
                header.classList.toggle('header-scrolled', window.scrollY > 50);
            });

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // --- AQI Widget Logic (Corrected & Secure) ---
            const aqiValueEl = document.getElementById('aqi-value');
            const aqiCategoryEl = document.getElementById('aqi-category');
            /* const aqiPollutantEl = document.getElementById('aqi-pollutant'); */
            const aqiCityEl = document.getElementById('aqi-city');

            const aqiWidget = document.getElementById('aqi-widget');
            if (aqiWidget) {
                aqiWidget.addEventListener('click', () => {
                    aqiWidget.classList.toggle('is-collapsed');
                });
            }
        });

            function getAqiInfo(aqi) {
                if (aqi <= 50) return { category: 'Good', className: 'aqi-good' };
                if (aqi <= 100) return { category: 'Moderate', className: 'aqi-moderate' };
                if (aqi <= 150) return { category: 'Unhealthy (SG)', className: 'aqi-usg' };
                if (aqi <= 200) return { category: 'Unhealthy', className: 'aqi-unhealthy' };
                if (aqi <= 300) return { category: 'Very Unhealthy', className: 'aqi-very-unhealthy' };
                return { category: 'Hazardous', className: 'aqi-hazardous' };
            }

            function fetchAqi(latitude, longitude) {
                // This relative URL calls your secure backend proxy
                const apiUrl = `/api/aqi?lat=${latitude}&lon=${longitude}`;
                
                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            const pollution = data.data.current.pollution;
                            const aqi = pollution.aqius;
                            const pm25 = pollution.p2?.conc ?? 'N/A';
                            const city = data.data.city;
                            const state = data.data.state;
                            const aqiInfo = getAqiInfo(aqi);

                            aqiValueEl.textContent = aqi;
                            aqiValueEl.className = `aqi-value ${aqiInfo.className}`;
                            aqiCategoryEl.textContent = aqiInfo.category;
                            aqiCategoryEl.className = `aqi-category ${aqiInfo.className}`;
                            /* aqiPollutantEl.innerHTML = `PM2.5: <strong>${pm25}</strong> µg/m³`; */
                            aqiCityEl.textContent = `${city}`;
                        } else {
                            throw new Error('API returned non-success status');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching AQI data:', error);
                        aqiValueEl.textContent = '-';
                        aqiCategoryEl.textContent = 'Unavailable';
                        aqiCityEl.textContent = 'Could not load data. Is the server running?';
                        aqiPollutantEl.textContent = '';
                    });
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        fetchAqi(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        aqiCityEl.textContent = 'Showing data for Lahore';
                        fetchAqi(31.5204, 74.3587); // Fallback to Lahore
                    }
                );
            } else {
                aqiCityEl.textContent = 'Geolocation not supported. Showing Lahore.';
                fetchAqi(31.5204, 74.3587); // Fallback to Lahore
            }

            // --- Hero Slider Logic ---
            const slides = [ { id: 'slide-1', title: 'Clearing the Air for a Healthier Pakistan', text: "Air pollution is the nation's leading environmental threat. We are dedicated to providing the data and tools needed to drive change.", button: 'Learn About The Crisis &rarr;', }, { id: 'slide-2', title: 'Data-Driven Action, Real-Time Impact', text: 'Our network of over 100 sensors across Pakistan provides transparent, real-time air quality data to citizens, researchers, and policymakers.', button: 'View Our Live Map &rarr;', }, { id: 'slide-3', title: 'Protecting Our Future Generations', text: 'Every citizen deserves the right to breathe clean air. Our initiatives focus on public health awareness and safeguarding vulnerable communities.', button: 'See Our Impact &rarr;', }, { id: 'slide-4', title: 'A Breath of Fresh Air is Possible', text: 'Through collaborative effort, scientific research, and public engagement, we can build a future with clear skies for Pakistan.', button: 'Get Involved &rarr;', }, ];
            let currentSlide = 0;
            const heroTextContent = document.getElementById('hero-text-content');
            function changeSlide() {
                document.getElementById(slides[currentSlide].id).classList.remove('active');
                currentSlide = (currentSlide + 1) % slides.length;
                document.getElementById(slides[currentSlide].id).classList.add('active');
                heroTextContent.style.opacity = '0';
                setTimeout(() => {
                    const slideData = slides[currentSlide];
                    heroTextContent.innerHTML = `<div class="hero-text-container"><h1>${slideData.title}</h1><p>${slideData.text}</p><a href="#map" class="cta-button">${slideData.button}</a></div>`;
                    heroTextContent.style.opacity = '1';
                    heroTextContent.style.transition = 'opacity 1s ease-in-out';
                }, 800);
            }
            setInterval(changeSlide, 6000);

            // --- General Animation Observer ---
            const animationObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('is-visible'); });
            }, { threshold: 0.1 });
            document.querySelectorAll('.animate-on-scroll').forEach(el => animationObserver.observe(el));
            
            // --- Data for Map & Chart ---
            const chartData = { Lahore: {"2017":196.27,"2018":117.98,"2019":100.02,"2020":83.10,"2021":90.99,"2022":107.97,"2023":105.91,"2024":104.58}, Karachi: {"2017":38.83,"2018":47.92,"2019":37.75,"2020":54.27,"2021":58.19,"2022":48.69,"2023":52.20,"2024":46.22}, Peshawar: {"2017":62.54,"2018":76.79,"2019":64.74,"2020":43.87,"2021":101.25,"2022":95.92,"2023":84.01,"2024":95.78}, Islamabad: {"2017":41.78,"2018":44.07,"2019":42.38,"2020":44.42,"2021":47.00,"2022":41.79,"2023":51.11,"2024":54.41} };
            const cityColors = { Lahore: 'var(--color-lahore)', Karachi: 'var(--color-karachi)', Peshawar: 'var(--color-peshawar)', 'Islamabad': 'var(--color-islamabad)' };

            // --- D3.js Chart Logic ---
            function drawChart() {
                const svg = d3.select("#timeline-chart"), margin = {top: 60, right: 20, bottom: 60, left: 50}, width = +svg.attr("width") - margin.left - margin.right, height = +svg.attr("height") - margin.top - margin.bottom;
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                const years = Object.keys(Object.values(chartData)[0]), cities = Object.keys(chartData);
                const x = d3.scalePoint().range([0, width]).padding(0.5).domain(years);
                const y = d3.scaleLinear().range([height, 0]).domain([0, d3.max(Object.values(chartData).flatMap(d => Object.values(d))) * 1.1]);
                const line = d3.line().x(d => x(d.year)).y(d => y(d.value)).defined(d => d.value !== undefined);
                g.append("g").attr("class", "x-axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickSize(0).tickPadding(10));
                const yAxisGroup = g.append("g").attr("class", "y-axis").call(d3.axisLeft(y).tickValues([0, 5, 50, 100, 150, 200]).tickSize(-width).tickFormat(d => d === 5 ? "5 (WHO)" : d));
                yAxisGroup.select(".domain").remove();
                yAxisGroup.selectAll(".tick line").attr("stroke", "var(--color-border)").filter(d => d === 5).attr("stroke-dasharray", "4 4");
                g.append("text").attr("transform", `rotate(-90)`).attr("y", -20).attr("x", -height / 2).attr("dy", "-2em").style("text-anchor", "middle").style("fill", "grey").style("font-size", "10px").style("font-family", "var(--font-main)").text("PM2.5 conc. (µg/m³)");
                const chartArea = g.append("g").attr("class", "chart-area");
                cities.forEach((city) => {
                    const data = years.map(year => ({ year: year, value: chartData[city][year] }));
                    d3.select("#chart-legend").append("div").attr("class", "legend-item").attr("data-city", city).html(`<div class="legend-color" style="background-color: ${cityColors[city]}"></div>${city}`);
                    const path = chartArea.append("path").datum(data).attr("class", "data-line").attr("id", `line-${city}`).attr("d", line).style("stroke", cityColors[city]);
                    const pathLength = path.node().getTotalLength();
                    path.attr("stroke-dasharray", pathLength + " " + pathLength).attr("stroke-dashoffset", pathLength);
                    chartArea.selectAll(`.point-${city}`).data(data.filter(d => d.value !== undefined)).enter().append("circle").attr("class", `data-point point-${city}`).attr("cx", d => x(d.year)).attr("cy", d => y(d.value)).attr("r", 4).style("stroke", cityColors[city]).on("mouseover", function(event, d) { d3.select(this).attr("r", 6); g.append("text").attr("class", "tooltip-text").attr("x", x(d.year)).attr("y", y(d.value) - 10).attr("text-anchor", "middle").text(`${d.value.toFixed(1)}`); }).on("mouseout", function() { d3.select(this).attr("r", 4); g.select(".tooltip-text").remove(); });
                });
                const chartObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => { if (entry.isIntersecting) { d3.selectAll(".data-line").transition().duration(2000).ease(d3.easeCubic).delay((d, i) => i * 150).attr("stroke-dashoffset", 0); chartObserver.unobserve(entry.target); } });
                }, { threshold: 0.5 });
                chartObserver.observe(document.getElementById('timeline-chart'));
                d3.selectAll(".legend-item").on("click", function () { const city = d3.select(this).attr("data-city"), isActive = d3.select(this).classed("is-dimmed"); d3.select(this).classed("is-dimmed", !isActive); d3.select(`#line-${city}`).classed("is-dimmed", !isActive); });
            }
            drawChart();

            // --- PNG Map Logic ---
            const mapLayer = document.getElementById('map-interactive-layer');
            const mapTooltip = document.getElementById('map-tooltip');
            if (mapLayer) {
                const mapCityData = { 'Islamabad': { top: '30%', left: '68%', aqi: Math.round(chartData['Islamabad']['2024']), color: cityColors['Islamabad'] }, 'Lahore': { top: '45%', left: '72.5%', aqi: Math.round(chartData['Lahore']['2024']), color: cityColors['Lahore'] }, 'Peshawar': { top: '26%', left: '61%', aqi: Math.round(chartData['Peshawar']['2024']), color: cityColors['Peshawar'] }, 'Karachi': { top: '90%', left: '45%', aqi: Math.round(chartData['Karachi']['2024']), color: cityColors['Karachi'] }, };
                Object.keys(mapCityData).forEach(city => {
                    const data = mapCityData[city];
                    const marker = document.createElement('div');
                    marker.className = 'map-marker';
                    marker.dataset.city = city;
                    marker.style.top = data.top;
                    marker.style.left = data.left;
                    marker.style.setProperty('--marker-color', data.color);
                    mapLayer.appendChild(marker);
                });
                document.querySelectorAll('.map-marker').forEach(marker => {
                    marker.addEventListener('mouseenter', e => {
                        const city = e.currentTarget.dataset.city;
                        const data = mapCityData[city];
                        let level = 'Good';
                        if (data.aqi > 5) level = 'Moderate'; if (data.aqi > 35) level = 'Unhealthy for Sensitive Groups'; if (data.aqi > 55) level = 'Unhealthy';
                        mapTooltip.innerHTML = `<h4>${city}</h4><p>2024 Annual Avg: <span class="aqi-value" style="color:${data.color};">${data.aqi}</span><span class="unit">µg/m³ PM2.5</span></p><small>${level}</small>`;
                        mapTooltip.style.left = `${e.currentTarget.offsetLeft - mapTooltip.offsetWidth / 2 + e.currentTarget.offsetWidth / 2}px`;
                        mapTooltip.style.top = `${e.currentTarget.offsetTop - mapTooltip.offsetHeight - 15}px`;
                        mapTooltip.classList.add('is-visible');
                    });
                    marker.addEventListener('mouseleave', () => mapTooltip.classList.remove('is-visible'));
                });
            }
        });
    </script>
</body>
</html>